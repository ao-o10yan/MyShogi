
# 『将棋神やねうら王』(2018年8月31日発売) アップデートなどの作業進捗 (Work In Progress)


- このファイルは、既知の問題や作業中の内容を明示することにより、それらに対するバグ報告を未然に防ぐためのものです。

- マイナビ公式のアップデート情報については、[マイナビ 将棋神やねうら王](https://book.mynavi.jp/ec/products/detail/id=92007)をご確認ください。
- 全体的な操作説明については[オンラインマニュアル](online_manual.md)をご覧ください。
- サウンドが再生されない、CPU負荷が高すぎる/低すぎるなどについては、[よくある質問](faq.md)をご覧ください。
- デバッグ機能の使い方などは、[開発者向け機能](dev_manual.md)をご覧ください。
- バグ、要望等は、[バグ・要望等　総合受付](https://github.com/yaneurao/MyShogi/issues/33)にどうぞ。


# 修正作業中


- 詰将棋エンジンでの検討
  - 詰みがあるのに不詰が返ってくることがある。(ミクロコスモスの詰みの手前の局面など)
    - Hashメモリの割り当てが小さいとこの現象が起きるらしい。
    // tanuki-さん調査中


# Update2(2018年9月中旬ごろリリース予定)に向けて作業中です(ここに書かれているすべての機能追加をお約束するものではありません)


対局
  - 対局中断→再開が欲しい。
  - 棋譜の途中から対局をするとき、そこより手数を戻そうとすると持ち時間がゼロになるので時間切れ負けになる件

- 棋譜
  - 棋譜ウィンドウのフロート
  - 棋譜コメントの表示、編集等
  - 思考エンジンの読み筋を棋譜コメントに記録する
  - 本譜のみ書き出し
  - 棋譜のマージ

- 棋譜解析

- 形勢グラフ(作業中)
	- このウィンドウ邪魔なので、検討ウィンドウに埋める予定
  - ToolStripの◀▶で局面を移動させた時にその局面での形勢表示にならない。
    - 検討ウィンドウのほうと合わせ、通知のハンドラちゃんと書く。
  - 着手や終局の直後に入れ違いで前の局面の思考が送られてきた時に、次の局面の評価値として記録してしまう。
    - あとで修正する。
  - このソフトで保存した棋譜を再度読み込んだ時にその評価値が形勢グラフに反映されない。
  - 駒落ちの時、詰まされると落ちる。(tkponさん)
    - 形勢グラフの範囲外にプロットしている模様。


# 対応を検討中


- USIプロトコル対応エンジンを任意に追加する機能

- ponder(「相手の手番で先読み」)
  - この実装、わりとややこしくて、激指ユーザーとかがターゲットなので必須機能とも言えないので後回し。


# 作業中の内容


- マスターアップ完了で一段落したため、現在、作業中の内容はありません。
- アップデートに向けて、上記の内容を一つずつ作業していきます。


# 改修履歴


- "1.0.9"→"1.1.0" [2018/08/31]-[2018/08/XX]
  - 連続対局中にその旨を画面上に表示するように。(48さん他)
    - 対応しました。勝敗とRも表示するようにしました。
  - 棋譜ファイルを読み込んだ時に駒落ちのときに対局開始時に上手/下手と表示されないことがある。(48さん)
    - 駒落ちの判定きちんとするようにしました。(任意局面であっても駒が平手から欠落していれば駒落ちと判定。後手側が上手、先手側が下手と判定。)
  - アセンブリバージョンを1.2.0に。(忘れないうちに変更)


- "1.0.8"→"1.0.9" [2018/08/28]-[2018/08/30]
  - 秒読みのときに対局中断したときに、0/10のように分子が0になってしまうのを修正。
    - タイマーを停止させる直前の文字列を復元するようにした。
  - 対局終了後、ネームプレートが初期化されるの修正。
  - 棋譜に名前をつけて保存するときに思考エンジンの場合はプリセット名も含めて保存するように。
  - メニューに「ウィンドウ」→「対局結果一覧」
    - 対局結果棋譜の読み込みが出来るようになった。とりま、対局結果一覧はこれでいい感じ。
    - 対局結果のクリアとか必要？上限に達した分を自動削除していくコードが必要。あとで考える。
  - メニューに「ウィンドウ」→「対局結果の自動保存設定」追加。
  - 対局結果一覧ウィンドウの追加
    - 対局棋譜の自動保存
    - 対局結果の一覧
  - 盤面編集で移動元と移動先が同じだと手駒が増える。(masaさん)
    - 前回仕様を変更したときの修正忘れでした。修正しました。
  - 千日手の判定がおかしい。(masaさん)
  - Hashの計算用のテーブルの手駒のところの初期化が一部間違っていて、手駒があるときに同一局面だと判定されないバグがありました。修正しました。
  - 対局中に長時間放置しているとメモリ不足で落ちる。(zu2さんの指摘)
    - MenuItemがリソースリークしていました。修正しました。
  - ミニ盤面を対局開始の局面になっているほうが良いのでは。(masaさん)
    - そうするようにしました。
  - ミニ盤面、駒落ちのときに駒が駒箱のところに散らばったままになるの修正。
  - 細長い駒台表示のときに駒落ちにしてると駒箱のところに駒が表示されるの修正。


- "1.0.7"→"1.0.8" [2018/08/25]-[2018/08/28]
  - 対局設定ダイアログに連続対局のときに先後入れ替えないオプションを追加
  - 「先後入替」したときに、「後手の時間設定を個別にする」でなければ先後の持ち時間を入れ替えるべきでない。連続対局についても同様。(48さん)
    - 対応しました。
  - 連続対局でプレイヤーを入れえるとき、終了後に元の状態に戻す処理追加。
  - 盤面編集で移動元・移動先の2駒交換になるの、将棋所やShogiGUIのように手駒に移動して欲しい。(matrixさん)
    - そのように仕様変更しました。また2駒目が玉の場合、駒箱に移動するようにしました。
    - あと、手駒の駒を盤面に移動させたとき、その升に駒があったら、手駒を移動させたほうの駒台にその駒を戻すようにしました。
  - 対局開始時、駒落ちなら「先手」「後手」ではなく「上手」「下手」と表示。(masaさん)
    - 対応しました。
  - 局面図の出力において、「５八金まで」のように最終手の指し手も出力するようにした。(Mizarさんのプルリク)
  - 詰みの局面から開始したときに、「対局開始」だけが表示されるの「対局終了」だけが表示されるように修正。
  - 検討モードに入るときにも「対局開始」と表示されていたの修正。


- "1.0.6"→"1.0.7" [2018/08/24]-[2018/08/25]
  - 人間同士の対局で、検討ウィンドウが必要ないときは、最初から生成しないようにする。
    - 子ダイアログを一瞬表示して消すと(デスクトップと親ダイアログの再描画が発生して)画面がちらつくので。
  - 対局開始＆対局終了、勝ち、負け、引き分けの画面エフェクト追加
  - 対局開始時に盤面反転が起きるときに盤面がちらつくことがある問題修正。
  - KIF形式での局面図の出力修正。
    - V1.01でSVG出力対応にしたとき以降、KIF形式の局面図の出力が動かなくなっていた模様。
    - KIF: 局面図出力で1手前が無くとも問答無用で1手戻そうとしていた #45 (Mizarさんのプルリク)
  - 連続対局で「現在の局面」からが機能するようになった。
    - 特定の局面の形勢の優劣の研究に使えそうな？
  

- "1.0.5"→"1.0.6" [2018/08/22]-[2018/08/24]
  - 棋譜の分岐の途中の局面から対局を開始したときに、棋譜ウィンドウの選択行がその局面ではなく分岐開始のところになるのを修正。
  - 次分岐ボタンが有効(Enable = true)な状態で対局再開したときにずっと次分岐ボタンが有効になっているの修正。
  - 分岐を作って、その分岐の手で「本譜」ボタンを押した直後に「次分岐」ボタンが効かない。(ぐららるさん)
    - 修正しました。
  - 連続対局のときに思考エンジンに対してisreadyコマンドを送信するようにした。
  - USIエンジンに対して、終局時に"gameover win"など"gameover"メッセージを送信するようにした。(連続対局の時にも適用)
  - メニューの表示のところ、ショートカットキーが重複してたの修正。
  - 連続対局の途中で対局開始をしたときに例外で落ちることがある。(masaさん)
    - Restartの処理がまずかったので修正。
  - デバッグウィンドウに「ログのクリア」ボタン追加。
  - 「デバッグの開始」を選ばずともログは全部メモリ上に残していくようにする。
  - 「デバッグの開始」をメニューから削除。「デバッグウインドウ」→「デバッグ用のログ」に変更。


- "1.0.4"→"1.0.5" [2018/08/21]-[2018/08/22]
  - 成り/不成の選択、後手側だと180度回転させてあって欲しい。(ぐららるさん)
    - 持ち時間設定の表示も180度回転させるべきという話になりそう。それは画面レイアウトずいぶん変更しないといけないのでタブレット端末対応の時に。
  - 詰検討のエンジン設定の個別設定に自動Hashの項目がないの修正。
    - 修正しました。見出しも追加しました。
  - 詰検討が落ちる件(ぐららるさん)
    - まだメモリが二重に確保されてました。メモリの多い環境で実行するとメモリが2重に確保された時にメモリ不足で落ちているようでした。エンジン側を修正しました。
  - TIME UPまでの時間が1秒多かったのを修正。
  - 秒読みのときに時間切れになったときに残り時間の表示が0/3になるのおかしいので修正。
  - 棋譜ウィンドウ・検討ウィンドウの表示手番文字を▲△から☗☖に戻す
  - 棋譜ウィンドウ・検討ウィンドウのCSA形式の表示選択追加対応。


- "1.0.3"→"1.0.4" [2018/08/19]-[2018/08/21]
  - 棋譜・検討ウィンドウの読み筋のところ、chess式の表示があって欲しい。(masaさん)
    - メニューの「表示」のところから選べるようにしました。
  - 棋譜ウィンドウで時間切れの時など、手番記号がなかったの修正。
  - 開始局面で、タイマー進んでないの修正。
    - エンジン初期化中の表示を行うために修正したときの影響。
    - 初期化が一瞬で終わる場合(人間同士の対局や詰検討)にタイマーの初期化等がGameModeの変更より早いタイミングで行われてしまうのが原因
    - V1.03で詰検討が一部の環境で落ちていたの、これが原因っぽい。

  - Windowを最小化して、終了させたときに次回起動時に変な場所にWindowが行く。(kumaさん)
    - 修正しました。検討ウィンドウのほうも同様の問題があったので修正しました。
    - また、メインウィンドウを表示するデスクトップ座標が、スクリーンの移動・変更などによって失われていたら、プライマリウィンドウに表示するようにしました。
  - メイン以外のFormのアイコン出てるの消す
  - フォントサイズがバラバラなのを統一する。(11ptで統一。設定上は11.25pt) 一部だけ9pt


- "1.0.2"→"1.0.3" [2018/08/16]-[2018/08/19]
  - 速攻時間切れ負けになったときに「ありがとうございました」を2回読み上げるの修正。
  - 先手と後手が異なる持ち時間設定であるときに後手のエンジンが切れ負けになる現象。(masaさん)
    - エンジンオプションのデフォルト値
      - NetworkDelay2 300 → 550に変更。
      - NetworkDelay 120 → 350に変更。(片道150msほどかかる + 誤差が0.1～0.2秒ほどあるようなので..)
    - これを反映するには、メニューの「ファイル」→「設定の初期化」→「各エンジン設定の初期化」で設定を初期化する必要がある。
  - 持ち時間なし + 1手2秒加算でやるといきなり時間切れになる件。
    - 1手ごとの秒加算、指し手の前にやらないといけないのに、指し手を指したあとにしていたのを修正。
  - 盤面編集の初期配置に「双玉で玉以外すべて駒箱に」を追加。
  - マウスのドラッグ＆ドロップで駒を移動させる時にも、駒が移動できる先の升のエフェクトを表示するように。(島田さんの要望)
    - 対応しました。
  - 盤面編集後、SVGなどで局面を書き出す時など、gamePly(ゲーム開始からの手数)が1になっていなかったのを1に固定するように修正。
  - 詰将棋エンジンでの検討で時刻が表示されていない件(masaさん)
    - 時間を思考エンジンからinfoで送られてきたtimeを使っていたが、こういうのはサーバー側計測であるべきなので
      サーバー側で勝手に時間を埋めることにした。
  - 検討ウィンドウに経過時刻、fだけでなくff(小数点以下2桁)まで表示するようにした。
  - mateとupperbound/lowerboundの組み合わせでparse errorになっていたの修正。
    - WhaleWatcherも同様だったので、えびふらいさんに報告しといた。


- "1.0.1"→"1.0.2" [2018/08/14]-[2018/08/15]
  - 棋譜の読み込みに失敗したときに棋譜ウィンドウの棋譜をリセットするようにした。
  - 盤面編集から抜けたあとは、棋譜ウインドウはクリアした方が良い。(masaさん)
    - 修正しました。
  - SVG出力で持駒領域が長くなったときに二段組にする #40 (tibigameさんのプルリク)
  - 起動直後に検討モードにしつつ駒移動のマウス操作をすると落ちる件。(和差積 商さん)
    - 合法手の判定、強化しました。(再現しないのでこれで修正できているかどうかよくわかりません)
  - デバッグウインドウで複数行の選択、Ctrl+Cで選択行のクリップボードへのコピーが出来るようにした。
  - エンジンオプション設定、デフォルト値に戻す手段が欲しい。(まふさん)
    - エンジンオプションのデフォルト値をTooltipのなかに表示するようにした。
    - メニュー「ファイル」→「設定の初期化」→「各エンジン設定の初期化」を追加。
    - メニュー「ファイル」→「設定の初期化」→「各表示設定などの初期化」を追加。
  - 検討ウィンドウのカラムの横幅を次回起動時に復元して欲しい。(masaさん)
    - 対応しました。
  - KIF形式で書き出した棋譜ファイルがKifu for Windows V7で読み込めない件に対応。(Mizarさんのプルリク)
    - 柿木将棋Ⅸで書き出した棋譜ファイル、手合割と持駒と同時に指定してあるが、これが読み込めるように修正。(Mizarさんのプルリク)
  - 詰将棋エンジン
    - 詰将棋エンジンで指定したHashの2倍のメモリが確保されていたのを修正。
    - 詰将棋エンジンでHashに16MBを指定したときに4096MB確保されるの修正。
  - 対局開始時、「エンジン初期化」が表示されるタイミングが遅い件。(ぐららるさん)
    - 改良しました。
  - 手番表示、名前に被る件。(tibigameさん)
    - ネームプレートと棋譜ウィンドウ少し下げて、ネームプレートの左上に持ってくる？
    - あまりいい画面レイアウトでもないのでこの件は見送り。
    

- "1.0.0"→"1.0.1" [2018/08/07]-[2018/08/14]
  - ショートカットキーの割り当て
    - Ctrl+Vをクリップボードからのペーストに割当て
    - Ctrl+CをクリップボードへのKIF形式での棋譜コピーに割当て。
    - Ctrl+Sを上書き保存に割り当て。
    - Ctrl+Nを通常対局に割り当て。
    - Ctrl+Eを盤面編集に割り当て。
  - エンジンでの検討中のファイルメニューを無効化するように変更。
  - エンジン側で例外が発生したときにGUI側、エラーダイアログを出して、終了させるようにした。
  - 検討ウィンドウの読み筋で１一への駒打ちの候補手が同～と表示される症状の修正 #37(Mizarさんのプルリク)
  - Clipboardメニュー追加・SVG出力周り整備 #36 (Mizarさんのプルリク)
    - メニューの「ファイル」→「クリップボードにコピー」,「クリップボードからペースト」追加。
  - 詰将棋のエンジン設定ダイアログで秒数の指定が出来るようにした。
    - timeoutの処理を追加した。時間内に詰みが発見出来なかった時に、その旨を検討ウィンドウに出力するようにした。
    - 詰みを発見できなかったときの評価値がMATEになっているの修正。
  - 詰将棋エンジンに関して
    - 詰み手順を復元する探索ルーチンの中で受け手側の手番かつ王手がかかっている状況で1手詰みルーチンを呼び出すバグを修正した #85(tanuki-さんのプルリク)
    - 逆王手がかかっている局面でも詰みを探索するようにした #84  (tanuki-さんのプルリク)
  - SVG形式での局面保存に対応(メニューのファイル→局面の保存) (tibigameさんのプルリク)
  - ウィンドウを最大化したならそれを終了時に保存/次回起動時に復元すべき。(tanuki-さん)
    - 最大化状態であるかどうかは保存されていないが、現在の実装で、DesktopLocationとサイズ自体は保存されているのでまあいいような…。
  - tooltipに間違えてVSのデザイナーから"\r\n"を使っていた箇所がある件。(和左積 商さん)
    - 「検討エンジン設定」ダイアログの「詳細設定」ボタンのtooltip、修正しました。


- β10.1を『将棋神やねうら王』(2018年8月31日発売)のマスターアップ版としました。開発・テストにご協力いただいた皆様、ありがとうございました。[2018/08/05]


  ## 過去の改修履歴

  - ここ以前の改修履歴については、[過去の改修履歴](過去の改修履歴.md)のほうに移動させました。
